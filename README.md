# Rails App Kubernetes Example

This is an example of Kubernetes deployable empty Rails project, containerizing the app using Docker. Using Helm charts to deploy the app and dependencies (postgres, redis).


## **tl; dr**

```shell
# to examine the final resource definition files
helm upgrade --install --namespace demo demo-drkiq ./chart/drkiq --debug --dry-run

# or remove --dry-run and create demo namespace for actual installation
kubectl create ns demo
helm upgrade --install --namespace demo demo-drkiq ./chart/drkiq

# to test the service is up and running
kubectl port-forward -n demo svc/demo-drkiq-rails 8000:80
```

and in your browser go to: http://localhost:8000


## What I've done

- I followed the blog post to get a dockerized app with slight changes:

  https://semaphoreci.com/community/tutorials/dockerizing-a-ruby-on-rails-application
- I've wrote [drkiq Helm chart](./chart/drkiq) that includes kubernetes files as templates, rendered templates make it easy to spin up the app with all dependencies (postgres/redis) by a single command on a new cluster, or even the same cluster and namespace just with different helm release name.
  - I used charts from hub.kubeapps.com for postgres and redis as dependencies (sub-charts) and did override the values I need in my parent chart [values file](./chart/drkiq/values.yaml)
  - I tried to make as much as possible configurable values read from the values file instead of being hard coded like env variables, configmap variables, image names/tags, etc..
  - I used configmap to store env variables, the configmap resourrce is generated by the chart
  - All kube resources generated by the chart are prefixed with the release name entered when installing it, and I use it as Helm convention to distinguish dependent services from other services dependencies. Release names are unique across the cluster so it's recommended to compose them of of __*targeted_env-project_name*__, for **drkiq** service something like `staging-drkiq`, `green-drkiq`, `blue-drkiq`, `live-drkiq`


### Building rails image

This image will be used by `unicorn` and `sidekiq`.

```shell
# Build the image
docker build -t <some-public-repo>/<some-tag> .

# and push it
docker push <some-public-repo>/<some-tag>
```

### Building nginx image (Not can be done as enhancement, but not implemented yet)

Using nginx to serve the assets as the following:
- By build 2 steps dockerfile, first step is the rails image to collect assets, the final is nginx image to copy asset files to it
- On helm chart adding new deployment for nginx with service and ingress rule to direct requests under assets path to nginx

### Install to Kubernetes

- Make sure helm client and tiller are installed on the local machine and the cluster
- Update the [values file](./chart/drkiq/values.yaml) for the following changes and any others needed (instead you can pass values adding `--set k=v` to helm install command)
  - Change `rails.image.repository` and `rails.image.tag` to the image/tag you pushed earlier (default values should work since they're set to image i already pushed)
  - Change `rails.ingress.hosts` to a list of your hosts ex: ["myapp.com"] since I'm using ClusterIP to expose the service and google ingress to route requests (or use port-forward just to test it's working)

Now we're ready to install the chart

```shell
helm install --namespace <kube-namespace> --name <release-name: ex. staging-drkiq> ./chart/drkiq
```
